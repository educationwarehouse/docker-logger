<script src="https://unpkg.com/htmx.org"></script>

<script>
    window.onload = function (){
        search_input = document.getElementById('search-input');
        search_input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addSearches();
            }
        });
        // Retrieve filters and search terms from local storage
        var filters = localStorage.getItem('filters');
        var searchTerms = localStorage.getItem('searchTerms');
        // If filters exist, check the corresponding checkboxes
        if (filters) {
            filters = filters.split(',');
            filters.forEach(function(filter) {
                var checkbox = document.querySelector('#filter-bar input[value="' + filter + '"]');
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        // If search terms exist, set the value of the search input
        if (searchTerms) {
            document.getElementById('search-input').value = searchTerms;
        }

        fetchData('/init/default/get_search_terms', 'search-terms', 'search-term', 'term');
        fetchData('/init/default/get_urls', 'urls', 'url', 'url');
        fetchData('/init/default/get_docker_names', 'docker-names', 'docker-name', 'docker')


    // Add event listener to all checkboxes
    document.querySelectorAll('#docker-names input[type=checkbox]').forEach(function(checkbox) {
        checkbox.addEventListener('change', updateExcludedDockerNames);
    });
    }
    function filterBar(paramName, paramValue) {
        // Get the current URL
        var url = new URL(window.location.href);
        // Create a URLSearchParams object
        var params = new URLSearchParams(url.search);

        if (paramValue) {
            // Set the parameter
            params.set(paramName, paramValue);
        } else {
            // Remove the parameter
            params.delete(paramName);
        }
        // Update the URL's search parameters
        url.search = params.toString();
        // Decode the URL
        var decodedUrl = decodeURIComponent(url.toString());
        // Update the current URL without reloading the page
        window.history.pushState({path:decodedUrl},'',decodedUrl);
        // Get the base URL from the data-base-url attribute
        var baseUrl = document.getElementById('logs').dataset.baseUrl;
        // Update the hx-get and hx-poll attributes of the logs div
        var logsDiv = document.getElementById('logs');
        logsDiv.setAttribute('hx-get', baseUrl + (paramValue ? '?' + paramName + '=' + paramValue : ''));
        logsDiv.setAttribute('hx-poll', baseUrl + (paramValue ? '?' + paramName + '=' + paramValue : ''));
        // Tell htmx to process the changes
        htmx.process(logsDiv);
    }

    function addFilters(checkbox) {
        // Get all checked checkboxes
        var checkedBoxes = document.querySelectorAll('#filter-bar input[type=checkbox]:checked');
        // Construct a string of their values separated by commas
        var filters = Array.from(checkedBoxes).map(c => c.value).join(',');
        filterBar('filters', filters);
        // Store the filters in local storage
        localStorage.setItem('filters', filters);
    }

    function addSearches() {
        // Get the input from the search bar
        var input = document.getElementById('search-input').value;
        // Split the input string by spaces to get the search
        var search = input.split(' ');
        filterBar('search', search.join(','));
        // Store the search terms in local storage
        localStorage.setItem('searchTerms', search.join(','));
    }


    function clearUrl() {
        // Clear the search bar
        document.getElementById('search-input').value = '';
        // Clear the checkboxes
        var checkedBoxes = document.querySelectorAll('#filter-bar input[type=checkbox]:checked');
        for (var i = 0; i < checkedBoxes.length; i++) {
            checkedBoxes[i].checked = false;
        }
        // Get the base URL from the data-base-url attribute
        var baseUrl = document.getElementById('logs').dataset.baseUrl;
        // Update the hx-get and hx-poll attributes of the logs div
        var logsDiv = document.getElementById('logs');
        logsDiv.setAttribute('hx-get', baseUrl);
        logsDiv.setAttribute('hx-poll', baseUrl);
        // Update the current URL without the search parameter
        var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.pushState({path:newUrl},'',newUrl);
        // Tell htmx to process the changes
        htmx.process(logsDiv);
        // Clear the filters and search terms from local storage
        localStorage.removeItem('filters');
        localStorage.removeItem('searchTerms');
    }

    function openModal(search_or_url) {
        console.log(search_or_url)
        document.getElementById('modal-' + search_or_url).style.display = "block";
    }

    function closeModal(search_or_url) {
        document.getElementById('modal-' + search_or_url).style.display = "none";
    }

    function submitItem(search_or_url) {
        var item = document.getElementById('new-' + search_or_url).value;
        var name = document.getElementById('name-' + search_or_url).value;
        if (item) {
            var params = new URLSearchParams();
            params.append(search_or_url, item);
            params.append('name', name);
            window.location.href = '/init/default/add_items?' + params.toString();
        }
    }

    function addToSearchBar(item) {
        var searchInput = document.getElementById('search-input');
        if (searchInput.value) {
            searchInput.value += ',';
        }
        searchInput.value += item;
    }


    function fetchData(endpoint, elementId, className, itemType) {
            fetch(endpoint)
                .then(response => response.json())
                .then(items => {
                    var divElement = document.getElementById(elementId);
                    divElement.innerHTML = '';
                    for (let i = 0; i < items.length; i++) {
                        var div = document.createElement('div');
                        div.className = className;
                        let currentItem = items[i];
                        if (itemType === 'term') {
                            div.textContent = items[i][1] || items[i][0];
                            div.onclick = function() {
                                addToSearchBar(currentItem[0]);
                            };
                            divElement.appendChild(div);
                        } else if (itemType === 'url') {
                            var a = document.createElement('a');
                            a.href = items[i][0];
                            a.textContent = items[i][1] || items[i][0];
                            div.appendChild(a);
                        } else if (itemType === 'docker') {
                            div.textContent = items[i];
                            div.onclick = function() {
                                addToSearchBar(currentItem);
                            };
                            var checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = true;
                            checkbox.value = items[i];
                            checkbox.onclick = function () {
                                updateExcludedDockerNames();
                            };
                            div.appendChild(checkbox);
                        }
                        if (itemType !== 'docker') {
                            var deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.onclick = (function(item, name) {
                                return function() { deleteItem(itemType, {url: item, name: name}); };
                            })(items[i][0], items[i][1]);
                            div.appendChild(deleteButton);
                        }
                        divElement.appendChild(div);
                    }
                });
        }

    function deleteItem(item, name) {
        var params = new URLSearchParams();
        params.append(item, name.url);
        params.append('name', name.name);
        window.location.href = '/init/default/delete_item?' + params.toString();
    }

    function updateExcludedDockerNames() {
        // Get all unchecked checkboxes
        var uncheckedBoxes = document.querySelectorAll('#docker-names input[type=checkbox]:not(:checked)');
        // Log the uncheckedBoxes NodeList
        console.log('Unchecked boxes:', uncheckedBoxes);
        // Construct a string of their values separated by commas
        var excludedDockerNames = Array.from(uncheckedBoxes).map(c => c.value).join(',');
        filterBar('exclude', excludedDockerNames);
    }

    function collapseAll() {
        var divs = ['search-terms-container', 'docker-names-container', 'urls-container'];
        for (var i = 0; i < divs.length; i++) {
            var div = document.getElementById(divs[i]);
            if (div.style.display === "none") {
                div.style.display = "block";
            } else {
                div.style.display = "none";
            }
        }
    }

</script>

<div id="filter-bar">
    {{for log_filter in log_filters:}}
    <input type="checkbox" id="{{=log_filter.log_filter}}" name="{{=log_filter.log_filter}}" value="{{=log_filter.log_filter}}" onchange="addFilters(this)">
    <label for="{{=log_filter.log_filter}}">{{=log_filter.log_filter}}</label><br>
    {{pass}}
</div>

<div id="search-bar">
    <input type="text" id="search-input" placeholder="Search">
    <button onclick="addSearches()">Search</button>
    <button onclick="clearUrl()">Clear (URL)</button>
</div>



<button onclick="collapseAll()">Toggle All</button>

<!--container for docker names-->
<div id="docker-names-container">
    <h2>Docker Names</h2>
    <p>Tip: Click on a Docker name to get it in the search bar</p>
    <div id="docker-names">
        <!-- Docker names will be added here -->
    </div>
</div>

<!--modal for search terms-->
<div id="modal-term" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
        <h2>Add a new search term</h2>
        <input type="text" id="new-term" placeholder="Enter new search term">
        <br>
        <input type="text" id="name-term" placeholder="Enter a name (default is search term)">
        <button onclick="submitItem('term')">Submit</button>
        <button onclick="closeModal('term')">Close</button>
    </div>
</div>

<!--container for search terms-->
<div id="search-terms-container">
    <h2>Search Terms</h2>
    <p>Tip: Click on a search term to get it in the search bar</p>
    <button onclick="openModal('term')" style="float: right;">New</button>
    <div id="search-terms">
        <!-- Search terms will be added here -->
    </div>
</div>


<div id="modal-url" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
        <h2>Add a new URL</h2>
        <input type="text" id="new-url" placeholder="Enter new URL">
        <br>
        <input type="text" id="name-url" placeholder="Enter a name (default is URL)">
        <button onclick="submitItem('url')">Submit</button>
        <button onclick="closeModal('url')">Close</button>
    </div>
</div>

<div id="urls-container">
    <h2>URLs</h2>
    <p>Tip: Click on a URL to open it</p>
    <button onclick="openModal('url')" style="float: right;">New</button>
    <div id="urls">
        <!-- URLs will be added here -->
    </div>
</div>


<div id="logs" hx-get="/init/default/realtime_logs" hx-trigger="load" hx-poll="/init/default/realtime_logs" data-base-url="/init/default/realtime_logs"></div>